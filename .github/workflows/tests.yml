name: tests

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Configure git safe directory (if needed here)
      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      # 2. Install PHP & extensions
      - name: Install PHP extensions
        run: |
          sudo apt-get update
          sudo apt-get install -y php8.4-cli php8.4-mbstring php8.4-sqlite3 unzip git curl

      # 3. Install Node.js & npm
      - name: Install Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

      # 4. Composer install
      - name: Install Composer dependencies
        run: COMPOSER_ALLOW_SUPERUSER=1 composer install --no-interaction --prefer-dist --optimize-autoloader

      # 5. NPM install & build
      - name: NPM Install & Build
        run: npm install && npm run build

  deploy:
  runs-on: ubuntu-latest
  needs: ci
  steps:
    - name: SSH to server and run deployment
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. Git safe directory
          git config --global --add safe.directory /var/www/royalpackaging

          # 2. Ensure PHP & extensions are installed
          sudo apt-get update
          sudo apt-get install -y php8.4-cli php8.4-mbstring php8.4-sqlite3 php8.4-mysql unzip git curl php8.4-fpm

          # 3. Node.js & npm
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # 4. Pull latest code
          cd /var/www/royalpackaging
          git pull origin main

          # 5. Composer install
          COMPOSER_ALLOW_SUPERUSER=1 composer install --no-interaction --prefer-dist --optimize-autoloader

          # 6. Artisan commands
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # 7. NPM build (if you build on server)
          npm install
          npm run build
